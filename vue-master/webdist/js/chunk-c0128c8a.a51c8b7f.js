(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-c0128c8a"],{"0548":function(t,i,e){"use strict";var a=e("8473e"),n=e.n(a);n.a},"0caa":function(t,i,e){},54243:function(t,i,e){"use strict";e.r(i);var a=function(){var t=this,i=t.$createElement,e=t._self._c||i;return e("div",{ref:"clipper",staticClass:"clipper-container"},[e("My-Header",{attrs:{title:t.pageTitle}}),e("canvas",{ref:"canvas"}),e("div",{staticClass:"clipper-part"},[e("div",{staticClass:"pCanvas-container"},[e("canvas",{ref:"pCanvas"})])]),e("div",{staticClass:"action-bar"},[e("button",{staticClass:"btn-cancel",on:{click:t._cancel}},[t._v("取消")]),e("button",{staticClass:"btn-ok",on:{click:t._clipper}},[t._v("确认")])]),e("div",{staticClass:"mask",class:{opacity:t.maskShow}}),e("div",{ref:"gesture",staticClass:"gesture-mask"})],1)},n=[],s=(e("fe59"),e("77ad"),e("513c"),e("20a5"),e("e35a"),e("5e9f"),e("08ba"),e("71c2")),r={name:"imageClipper",props:{img:{type:String,default:"https://game.flyh5.cn/resources/game/wechat/szq/images/img_01.png"},clipperImgWidth:{type:Number,default:300},clipperImgHeight:{type:Number,default:300}},watch:{img:function(){this.loadImgQueue.push(this.img),this._loadImg()}},data:function(){return{pageTitle:"图片裁剪1",originXDiff:0,originYDiff:0,maskShow:!0,maskShowTimer:null,ctx:null,pCtx:null,actionBarHeight:61,loadImgQueue:[],$img:null,imgLoaded:!1,imgLoading:!1,imgStartWidth:null,imgStartHeight:null,imgCurrentWidth:null,imgCurrentHeight:null,imgX:null,imgY:null,imgScale:1,imgMinScale:1,imgMaxScale:5,imgScaleStep:60,cWidth:0,cHeight:0}},mounted:function(){var t=this;setTimeout((function(){t._initClipper()}),10)},beforeDestroy:function(){var t=this.$refs.gesture;t.ontouchstart=null,t.ontouchmove=null,t.outouchend=null},methods:{_initClipper:function(){this.loadImgQueue.push(this.img),this._initCanvas(),this._loadImg(),this._initEvent()},_initCanvas:function(){var t=this.$refs.canvas,i=this.$refs.pCanvas,e=this.$refs.clipper.getBoundingClientRect(),a=parseInt(this.clipperImgWidth/window.devicePixelRatio),n=parseInt(this.clipperImgHeight/window.devicePixelRatio);this.ctx=t.getContext("2d"),this.pCtx=i.getContext("2d"),(a<0||a>e.width)&&(a=250),(n<0||n>e.height)&&(n=100),t.style.width=e.width+"px",t.style.height=e.height+"px",t.width=this._ratio(e.width),t.height=this._ratio(e.height),i.style.width=a+"px",i.style.height=n+"px",i.width=this._ratio(a),i.height=this._ratio(n);var s=t.getBoundingClientRect(),r=i.getBoundingClientRect();this.originXDiff=r.left-s.left,this.originYDiff=r.top-s.top,this.cWidth=s.width,this.cHeight=s.height},_initEvent:function(){var t=this,i=this.$refs.gesture,e=this.$refs.canvas.getBoundingClientRect(),a=0,n=0,s={},r=this.imgX,h=this.imgY,g=0,o=this.imgScale;i.addEventListener("touchstart",(function(i){if(t.imgLoaded)if(1===i.touches.length){var o=i.touches[0];a=o.pageX,n=o.pageY,r=t.imgX,h=t.imgY,s[o.identifier]=o}else if(2===i.touches.length){var c=i.touches[0],l=i.touches[1],m=c.pageX-e.left,u=c.pageY-e.top,d=l.pageX-e.left,p=l.pageY-e.top;a=parseInt((m+d)/2),n=parseInt((u+p)/2),g=t._pointDistance(m,u,d,p),s[c.identifier]=c,s[l.identifier]=l,a<t.imgX&&(a=t.imgX),a>t.imgX+t.imgCurrentWidth&&(a=t.imgX+t.imgCurrentHeight),n<t.imgY&&(n=t.imgY),n>t.imgY+t.imgCurrentHeight&&(n=t.imgY+t.imgCurrentHeight)}}),!1),i.addEventListener("touchmove",(function(i){if(i.preventDefault(),t.imgLoaded)if(t.maskShowTimer&&clearTimeout(t.maskShowTimer),t.maskShow=!1,1===i.touches.length){var c=i.touches[0].pageX,l=i.touches[0].pageY;t._drawImage(r+c-a,h+l-n,t.imgCurrentWidth,t.imgCurrentHeight)}else if(2===i.touches.length){var m=i.touches[0],u=i.touches[1],d=m.pageX-e.left,p=m.pageY-e.top,f=u.pageX-e.left,v=u.pageY-e.top,C=t._pointDistance(d,p,f,v),_=t.imgScale+parseFloat(((C-g)/t.imgScaleStep).toFixed(1));s[m.identifier]=m,s[u.identifier]=u,_!==o&&(_<t.imgMinScale?_=t.imgMinScale:_>t.imgMaxScale&&(_=t.imgMaxScale),o=_,t._scale(a,n,_))}}),!1),i.addEventListener("touchend",(function(i){if(t.imgLoaded){t.imgScale=o;var e=Array.prototype.slice.call(i.changedTouches,0);e.forEach((function(t){delete s[t.identifier]}));var g,c=[];for(g in s)s.hasOwnProperty(g)&&c.push(s[g]);c.length>0?(a=c[0].pageX,n=c[0].pageY,r=t.imgX,h=t.imgY):t.maskShowTimer=setTimeout((function(){t.maskShow=!0}),300);var l=t.imgX,m=t.imgY,u=t.$refs.pCanvas.getBoundingClientRect();l>u.left+u.width?l=u.left:l+t.imgCurrentWidth<u.left&&(l=u.left+u.width-t.imgCurrentWidth),m>u.top+u.height?m=u.top:m+t.imgCurrentHeight<u.top&&(m=u.top+u.height-t.imgCurrentHeight),t.imgX===l&&t.imgY===m||t._drawImage(l,m,t.imgCurrentWidth,t.imgCurrentHeight)}}))},_loadImg:function(){var t=this;if(!this.imgLoading&&0!==this.loadImgQueue.length){var i=this.loadImgQueue.shift();if(i){var e=new Image,a=function i(a){e.removeEventListener("load",i,!1),t.$img=e,t.imgLoaded=!0,t.imgLoading=!1,t._initImg(e.width,e.height),t.$emit("loadSuccess",a),t.$emit("loadComplete",a),t._loadImg()},n=function i(a){e.removeEventListener("error",i,!1),t.$img=e=null,t.imgLoading=!1,t.$emit("loadError",a),t.$emit("loadComplete",a),t._loadImg()};this.$emit("beforeLoad"),this.imgLoading=!0,this.imgLoaded=!1,e.src=this.img,e.crossOrigin="Anonymous",e.addEventListener("load",a,!1),e.addEventListener("error",n,!1)}}},_initImg:function(t,i){var e=null,a=null,n=this.cWidth,s=this.cHeight-this.actionBarHeight;t<=n&&i<=s?(e=t,a=i):t>n&&i<=s?(e=n,a=parseInt(i/t*n)):t<=n&&i>s||i>t?(e=parseInt(t/i*s),a=s):(e=n,a=parseInt(i/t*n)),e<=n&&a<=s?(this.imgStartWidth=e,this.imgStartHeight=a,this._drawImage((n-e)/2,(s-a)/2,e,a)):this._initImg(e,a)},_drawImage:function(t,i,e,a){this._clearCanvas(),this.imgX=parseInt(t),this.imgY=parseInt(i),this.imgCurrentWidth=parseInt(e),this.imgCurrentHeight=parseInt(a),this.ctx.drawImage(this.$img,this._ratio(t),this._ratio(i),this._ratio(e),this._ratio(a)),this.pCtx.drawImage(this.$img,this._ratio(t-this.originXDiff),this._ratio(i-this.originYDiff),this._ratio(e),this._ratio(a))},_clearCanvas:function(){var t=this.$refs.canvas,i=this.$refs.pCanvas;t.width=t.width,t.height=t.height,i.width=i.width,i.height=i.height},_ratio:function(t){return parseInt(window.devicePixelRatio*t)},_pointDistance:function(t,i,e,a){return parseInt(Math.sqrt((t-e)*(t-e)+(i-a)*(i-a)))},_scale:function(t,i,e){var a=parseInt(this.imgStartWidth*e),n=parseInt(this.imgStartHeight*e),s=parseInt(t-a*(t-this.imgX)/this.imgCurrentWidth),r=parseInt(i-n*(i-this.imgY)/this.imgCurrentHeight);this._drawImage(s,r,a,n)},_clipper:function(){var t=null;try{t=this.$refs.pCanvas.toDataURL()}catch(i){this.$toast("本地暂不支持预览，请移步线上预览~"),console.error("请在response header加上Access-Control-Allow-Origin，否则canvas无法裁剪未经许可的跨域图片")}this.$emit("ok",t)},_cancel:function(){this.$emit("cancel")},getBase64:function(t){return t.replace(/^data:image\/(png|jpg);base64,/,"")}},components:{MyHeader:s["a"]}},h=r,g=(e("edf9"),e("9ca4")),o=Object(g["a"])(h,a,n,!1,null,"ae0bc01e",null);i["default"]=o.exports},"71c2":function(t,i,e){"use strict";var a=function(){var t=this,i=t.$createElement,e=t._self._c||i;return e("div",{staticClass:"header"},[e("div",{staticClass:"wrap"},[t.isBack?e("div",{staticClass:"back",on:{click:t.back}},[e("i",{staticClass:"iconfont icon-fanhui1"})]):t._e(),e("h3",[t._v(t._s(t.title))])])])},n=[],s=(e("e35a"),e("5e9f"),{name:"",props:{title:{type:String,default:"页面标题"},isBack:{type:Boolean,default:!0}},data:function(){return{}},methods:{back:function(){var t=sessionStorage.getItem("prevPage")||"/";this.$router.replace(t),sessionStorage.setItem("prevPage","")}}}),r=s,h=(e("0548"),e("9ca4")),g=Object(h["a"])(r,a,n,!1,null,"20ec2505",null);i["a"]=g.exports},"8473e":function(t,i,e){},edf9:function(t,i,e){"use strict";var a=e("0caa"),n=e.n(a);n.a}}]);